{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["import type { WorkerOptions } from 'node:worker_threads';\n\nimport { once } from 'node:events';\nimport { URL, pathToFileURL } from 'node:url';\nimport { Worker } from 'node:worker_threads';\nimport callsites from 'callsites';\n\ninterface WorkerData {\n    readonly parent?: string | URL | undefined;\n    readonly specifiers: readonly string[];\n}\n\nconst isUrl = /^\\w+:\\/\\/.+/;\nconst thisUrl = import.meta.url;\nconst workerURL = createWorkerURL(workerContext);\n\n/**\n * Resolve a (single) module specifier.\n * @see [`import.meta.resolve`](https://nodejs.org/dist/latest-v16.x/docs/api/esm.html#importmetaresolvespecifier-parent)\n * @param specifier The module specifier to resolve relative to `parent`.\n * @param parent    The absolute parent module URL to resolve from. (@defaultValue [`import.meta.url`](https://nodejs.org/dist/latest-v16.x/docs/api/esm.html#importmetaurl))\n * @returns         A `Promise` that resolves to a module URL string.\n*/\nexport async function importMetaResolve(specifier: string, parent?: string | URL) {\n    parent ??= getCallerUrl();\n    const [result] = await importMetaResolveAll([specifier], parent);\n    return result!;\n}\n\n/**\n * Resolve multiple module specifiers with same `parent`.\n * @param specifiers    The array of module specifiers to resolve relative to `parent`.\n * @param parent        The absolute parent module URL to resolve from. (@defaultValue [`import.meta.url`](https://nodejs.org/dist/latest-v16.x/docs/api/esm.html#importmetaurl))\n * @returns             A `Promise` that resolves to an array of module URL strings.\n */\nexport async function importMetaResolveAll(specifiers: readonly string[], parent?: string | URL) {\n    parent ??= getCallerUrl();\n    const execArgv = Object.freeze([\n        ...new Set(process.execArgv)\n            .add('--experimental-import-meta-resolve')\n            .add('--no-warnings')\n    ]);\n    const workerData: WorkerData = { parent, specifiers };\n    const workerOptions = { execArgv, workerData } as WorkerOptions;\n    const worker = new Worker(workerURL, workerOptions);\n    try {\n        const [results] = await once(worker, 'message') as [string[]];\n        return results;\n    } catch (e) {\n        const { message, name } = Object(e) as Error;\n        throw Object.assign(new Error(message), { name });\n    } finally {\n        void worker.terminate();\n    }\n}\n\nfunction createWorkerURL(workerContextFunction: () => void | Promise<void>) {\n    const fText = workerContextFunction.toString();\n    const fBody = fText.slice(fText.indexOf('{') + 1, fText.lastIndexOf('}')).trim();\n    return new URL(`data:text/javascript,${encodeURIComponent(fBody)}`);\n}\n\nfunction getCallerUrl() {\n    for (const callSite of callsites()) {\n        const uri = callSite.getFileName();\n        if (uri) {\n            const url = isUrl.test(uri) ? uri : pathToFileURL(uri).href;\n            if (url !== thisUrl) {\n                return url;\n            }\n        }\n    }\n    return undefined;\n}\n\nasync function workerContext() {\n    const { parentPort, workerData } = await import('node:worker_threads'); // eslint-disable-line @typescript-eslint/no-unsafe-assignment\n    const { parent, specifiers } = workerData as WorkerData;\n    const results = await Promise.all(specifiers.map(specifier => import.meta.resolve!(specifier, parent)));\n    parentPort!.postMessage(results);\n}\n"],"names":["isUrl","thisUrl","import","meta","url","workerURL","createWorkerURL","workerContext","async","importMetaResolve","specifier","parent","getCallerUrl","result","importMetaResolveAll","specifiers","execArgv","Object","freeze","Set","process","add","workerData","workerOptions","worker","Worker","results","once","e","message","name","assign","Error","terminate","workerContextFunction","fText","toString","fBody","slice","indexOf","lastIndexOf","trim","URL","encodeURIComponent","callSite","callsites","uri","getFileName","test","pathToFileURL","href","undefined","parentPort","Promise","all","map","resolve","postMessage"],"mappings":"2JAYA,MAAMA,EAAQ,cACd,MAAMC,EAAUC,OAAOC,KAAKC,IAC5B,MAAMC,EAAYC,EAAgBC,GAS3BC,eAAeC,EAAkBC,EAAmBC,GACvDA,IAAAA,EAAWC,KACX,MAAOC,SAAgBC,EAAqB,CAACJ,GAAYC,GACzD,OAAOE,CACX,CAQOL,eAAeM,EAAqBC,EAA+BJ,GACtEA,IAAAA,EAAWC,KACX,MAAMI,EAAWC,OAAOC,OAAO,IACxB,IAAIC,IAAIC,QAAQJ,UACdK,IAAI,sCACJA,IAAI,mBAEb,MAAMC,EAAyB,CAAEX,SAAQI,cACzC,MAAMQ,EAAgB,CAAEP,WAAUM,cAClC,MAAME,EAAS,IAAIC,EAAOpB,EAAWkB,GACrC,IACI,MAAOG,SAAiBC,EAAKH,EAAQ,WACrC,OAAOE,CAMV,CALC,MAAOE,GACL,MAAMC,QAAEA,EAAOC,KAAEA,GAASb,OAAOW,GACjC,MAAMX,OAAOc,OAAO,IAAIC,MAAMH,GAAU,CAAEC,QAC7C,CAAS,aACDN,EAAOS,WACf,CACL,CAEA,SAAS3B,EAAgB4B,GACrB,MAAMC,EAAQD,EAAsBE,WACpC,MAAMC,EAAQF,EAAMG,MAAMH,EAAMI,QAAQ,KAAO,EAAGJ,EAAMK,YAAY,MAAMC,OAC1E,OAAO,IAAIC,EAAI,wBAAwBC,mBAAmBN,KAC9D,CAEA,SAASzB,IACL,IAAK,MAAMgC,KAAYC,IAAa,CAChC,MAAMC,EAAMF,EAASG,cACrB,GAAID,EAAK,CACL,MAAM1C,EAAMJ,EAAMgD,KAAKF,GAAOA,EAAMG,EAAcH,GAAKI,KACvD,GAAI9C,IAAQH,EAAS,CACjB,OAAOG,CACV,CACJ,CACJ,CACD,OAAO+C,SACX,CAEA3C,eAAeD,IACX,MAAM6C,WAAEA,EAAU9B,WAAEA,SAAqBpB,OAAO,uBAChD,MAAMS,OAAEA,EAAMI,WAAEA,GAAeO,EAC/B,MAAMI,QAAgB2B,QAAQC,IAAIvC,EAAWwC,KAAI7C,GAAaR,OAAOC,KAAKqD,QAAS9C,EAAWC,MAC9FyC,EAAYK,YAAY/B,EAC5B"}